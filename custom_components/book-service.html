<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<polymer-element name="book-service" attributes="query npage">

  <template>
    <link rel="stylesheet" href="book-service.css">
    
    <core-ajax
    id="ajax"
    url="http://it-ebooks-api.info/v1/search/{{query}}/page/{{npage}}"
    handleAs="json"
    on-core-response="{{handleResponse}}"></core-ajax>

    <paper-toast id="toast" text="We found {{result.Total}} books about {{query}}"></paper-toast>
    <paper-toast id="error" text="Apparently you have exceeded the limit of requests, try later =("></paper-toast>

    <ul>
      <template repeat="{{books}}">
        <li>
          <h3>{{Title}}</h3>
          <img src="{{Image}}">
          <p>{{Description}}</p>
          <paper-fab class="green" icon="arrow-forward" on-click="{{getlinkdownload}}"></paper-fab>
        </li>
      </template>
    </ul>

  </template>

  <script>
    Polymer({
      query: null,
      npage: 1,

      created: function() {
        this.books = [];
      },

      getlinkdownload: function(event, detail, sender){         
        var bookdialog = document.querySelector('book-dialog');
        bookdialog.rundialog(event.target.templateInstance.model.ID);
      },

      observe: {
        query: 'search',
        npage: 'search'
      },

      search: function(){
        console.log("change");
        this.$.ajax.go();
      },

      handleResponse: function(){
        var button = document.querySelector('paper-button');
        this.result = this.$.ajax.response;
        
        if (this.result.Error && !this.result.Books){
          this.$.error.show();
          return;
        }

        this.$.toast.show();

        if (this.result && this.result.Books) {
          this.books = this.result.Books;
          button.label="Load More Books";
        } else{
          this.books = [];
        }

      }

    });
  </script>

</polymer-element>